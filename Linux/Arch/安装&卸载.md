

## 准备
制作系统启动盘：推荐使用[Ventoy](https://www.ventoy.net/cn/index.html)

系统镜像下载：[下载地址](https://archlinux.org/download/)

从启动盘启动 live 环境系统：各个主板使用方式都不同，需要提前问下AI各个主板设置启动盘的方式或者启动菜单的启用方式，以HP笔记本为例，在启动时按下Esc，让后按下F9后可以打开启动菜单，然后选择从刚刚制作的启动盘进行启动

## 安装
### 安装前的设置工作
#### 设置键盘布局
默认为US键盘布局，一般不需要额外操作

```bash
localectl list-keymaps # 列出可用的布局
loadkeys us # 设置键盘布局
```

#### 验证启动模式
```bash
cat /sys/firmware/efi/fw_platform_size
```

![[Linux/Arch/attachments/40649a9ebd4ad86448f5891c99cc0d4b_MD5.png]]

64: 64位UEFI启动

32: 32位UEFI启动

<font style="background-color:#D8DAD9;">No such file or directory</font> : BIOS模式启动
#### 连接互联网
1. 确保网络适配器已被正确识别

```bash
ip link # 查看网络状态
ip link set interface up # 启用网络适配器
```

![[Linux/Arch/attachments/383da9f78edd94dcaa21ec03f4204f13_MD5.png]]

2. 连接有线网络

确保网线被正确插入

3. 连接无线网络

无线网卡需要先确保网卡没有被rfkill【Linux 内核模块】拦截，查询方式为

```bash
rfkill
---------
ID TYPE      DEVICE      SOFT      HARD
 0 bluetooth hci0   unblocked unblocked
 1 wlan      phy0   unblocked unblocked
-------
```

解锁Wlan网卡

```bash
rfkill unblock wlan
```

使用iwctl完成Wi-Fi连接

```bash
iwctl # 进入iwctl可交互模式
```

```bash
[iwd]# device list # 列出设备列表
[iwd]# device wlan0 set-property Powered on # 启用设备
[iwd]# station wlan0 scan # 扫描网络
[iwd]# station wlan0 get-networks # 获取可连接的网络
[iwd]# station wlan0 connect SSID # 连接网络
Passphrase: # 输入Wi-Fi密码
```

4. 查看当前IP地址，测试网络连通性

```bash
ip address # 查看当前IP地址
ping ping.archlinux.org # 测试网络连通性
```

![[Linux/Arch/attachments/9224f34420342a5df77f58b9b63bee67_MD5.png]]

#### 同步系统时间
```bash
timedatectl
```

![[Linux/Arch/attachments/efa3a0278e21f4704f957f7a38625cd7_MD5.png]]

#### 磁盘分区和挂载
1. 使用fdisk对磁盘进行分区

```bash
fdisk -l # 查看当前分区情况
```

![[Linux/Arch/attachments/c10800d16253fc94d8ee72428fc348a6_MD5.png]]

```bash
fdisk /dev/sda # 对设备/dev/sda进行分区
```

![[Linux/Arch/attachments/f0c3b24eb217903086469f87f33bdf77_MD5.png]]

```bash
g # 可选，新增一个空的GPT分区表（会格式化硬盘）
```

![[Linux/Arch/attachments/16e8c3fd4e7f1c5bbc0557b766b9a58f_MD5.png]]

```bash
n # 新建EFI分区
# enter 指定分区号（默认即可）
# enter 指定其实位置（默认即可）
+4G # 指定终止位置（EFI分区推荐分4G）
t # 切换分区类型
1 # enter 选择刚刚新增的分区
EFI System # 设置分区类型为EFI System
```

![[Linux/Arch/attachments/5c868e734a76f5ec81437b1e6915b489_MD5.png]]

```bash
n # 新建root分区
# enter 指定分区号（默认即可）
# enter 指定其实位置（默认即可）
# enter 指定终止位置（root分区使用剩下的所有空间）
```

![[Linux/Arch/attachments/95dfe5e5cfcdc3b9b8cb8fb87fb21179_MD5.png]]

```bash
p # 打印当前分区表
w # 将分区表写入磁盘
```

![[Linux/Arch/attachments/7c878f30fc9b44b81890dd0ce384dcdb_MD5.png]]

```bash
fdisk -l # 再次查看分区情况
```

![[Linux/Arch/attachments/d7d50204595852381ac0c0c88c52ce7c_MD5.png]]

2. 格式化分区

```bash
mkfs.fat -F 32 /dev/sda1 # 格式化EFI分区为fat32格式
```

![[Linux/Arch/attachments/6013107e883c40a732853bb36de17ec4_MD5.png]]

```bash
mkfs.btrfs /dev/sda2 # 格式化系统Root分区（btrfs格式）
```

![[Linux/Arch/attachments/48bee9d9a3b8539f7736766da725c450_MD5.png]]

```bash
mount /dev/sda2 /mnt -o compress=zstd # 挂载root分区，指定压缩策略为zstd
btrfs subvolume create /mnt/@ # 新建root子卷
btrfs subvolume create /mnt/@boot # 新建boot子卷
btrfs subvolume create /mnt/@home # 新建home子卷
btrfs subvolume create /mnt/@swap # 新建swap子卷
btrfs subvolume list -t /mnt # 查看子卷情况
umount /mnt # 卸载root分区
```

![[Linux/Arch/attachments/56f11eb05b2b29c267edb00aa9ab2e16_MD5.png]]

3. 挂载分区

```bash
mount /dev/sda2 /mnt/ --mkdir -o compress=zstd,subvol=/@ # 挂载root子卷
mount /dev/sda2 /mnt/boot/ --mkdir -o compress=zstd,subvol=/@boot # 挂载boot子卷
mount /dev/sda2 /mnt/home/ --mkdir -o compress=zstd,subvol=/@home # 挂载home子卷
mount /dev/sda2 /mnt/swap/ --mkdir -o compress=zstd,subvol=/@swap # 挂载swap子卷
mount /dev/sda1 /mnt/efi/ --mkdir # 挂载efi分区
lsblk -pf # 查看挂载情况
```

![[Linux/Arch/attachments/508de591a7cb4de92e2c4d7eb399674d_MD5.png]]

4. 新增交换文件并开启交换功能

```bash
btrfs filesystem mkswapfile --size 4g --uuid clear /mnt/swap/swapfile
swapon /mnt/swap/swapfile
```

![[Linux/Arch/attachments/1e14a956391c7333923d61eda78a6d18_MD5.png]]

### 正式安装
#### 选择系统安装源
1. 编辑镜像源配置/etc/pacman.d/mirrorlist，将China的源配置置于文件顶部

```bash
vim /etc/pacman.d/mirrorlist
```

#### 安装系统
```bash
pacstrap -K /mnt base base-devel linux linux-firmware # 安装系统
pacstrap /mnt vi vim sudo networkmanager btrfs-progs ntfs-3g e2fsprogs dosfstools grub efibootmgr os-prober# 安装常用软件
```

![[Linux/Arch/attachments/c18406205f70b5946efe608ff4278fa9_MD5.png]]

| vi vim | 编辑器软件 |
| --- | --- |
| sudo | sudo工具 |
| networkmanager | 网络配置管理工具，gnome和kde都可以用 |
| btrfs-progs,ntfs-3g,e2fsprogs,dosfstools | 磁盘工具 |
| grub,efibootmgr,os-prober | 系统引导配置工具 |


### 安装后的配置
#### 基础配置
1. 设置启动自动挂载磁盘

```bash
genfstab -U /mnt >> /mnt/etc/fstab # 生成fstab配置文件
cat /mnt/etc/fstab # 校验配置文件
```

![[Linux/Arch/attachments/631b31933c245017121f25ad0e7a9183_MD5.png]]

2. 切换到新系统环境

```bash
arch-chroot /mnt
```

![[Linux/Arch/attachments/3017cb05bed9e3a2ad7ef8f4f8272ac7_MD5.png]]

3. 设置时区并同步系统时钟

```bash
ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime # 设置时区
hwclock --systohc # 同步系统时钟
```

![[Linux/Arch/attachments/6483ff787c03ef4e6aa2235de93d6759_MD5.png]]

4. 生成本地化文件

```bash
# 编辑 /etc/locale.gen
vim /etc/locale.gen
# 取消注释 
en_US.UTF-8 UTF-8
zh_CN.UTF-8 UTF-8
```

![[Linux/Arch/attachments/f07f436394a135c3cacea3e232f5ee59_MD5.png]]![[Linux/Arch/attachments/c832da3087ebbeda11acf5c9bd4cd8f4_MD5.png]]

```bash
locale-gen # 生成本地化文件
```

![[Linux/Arch/attachments/1af1194d5a3410de306f9b99b91d65a3_MD5.png]]

```bash
vim /etc/locale.conf # 设置语言变量为en_US.UTF-8
cat /etc/locale.conf # 确认设置是否成功
```

![[Linux/Arch/attachments/90968895dc54f2324f37bad6783b0047_MD5.png]]

```bash
vim /etc/vconsole.conf # 设置键盘布局
cat /etc/vconsole.conf # 确认设置是否成功
```

![[Linux/Arch/attachments/36e1f16200a530d3eb99a6a064875143_MD5.png]]

5. 设置主机名

```bash
vim /etc/hostname # 设置主机名，随便取一个
```

![[Linux/Arch/attachments/72d296f0ce0f73802fb34d202f99c8e5_MD5.png]]

6. 设置root密码

```bash
passwd # 设置root密码
```

![[Linux/Arch/attachments/c513e1282529f5022107d71dd4f9fb0a_MD5.png]]

7. 添加拥有系统管理员权限的账号

```bash
useradd -m -G wheel chenfq
passwd chenfq
```

![[Linux/Arch/attachments/4df1d55e4383815189380215a9afd3ab_MD5.png]]

将wheel组设置为拥有超级管理员权限

```bash
visudo # 编辑/etc/sudoers 文件，需要确保sudo和vi编辑器以及安装好了
# 取消 %wheel ALL=(ALL:ALL) ALL 注释
su - chenfq # 切换到刚刚创建的账户
sudo pacman -Syu # 验证是否管理员权限已经生效
```

#### 系统引导配置
推荐使用grub，大部分Linux发行版都在用的系统引导程序

```bash
pacman -S grub efibootmgr os-prober #安装grub和对应的依赖
```

![[Linux/Arch/attachments/24fa9676dd6b4a9054ebee9320c5aa92_MD5.png]]

```bash
# /etc/default/grub 取消这一行注释
GRUB_DISABLE_OS_PROBER=false
```

![[Linux/Arch/attachments/9dc02228db9b135f3a2b4ee16f6025b0_MD5.png]]

```bash
grub-install --target=x86_64-efi --efi-directory=/efi --bootloader-id=grub --modules="tpm" --disable-shim-lock # 生成配置文件
```

![[Linux/Arch/attachments/d3a6461b0a0cf3ba2b353d9dceb1fed2_MD5.png]]

```bash
grub-mkconfig -o /boot/grub/grub.cfg # 生成grub配置文件
```

![[Linux/Arch/attachments/fca952d19a661019d8b4bf45e598b380_MD5.png]]

#### 重启系统
```bash
exit # 退出chroot环境
reboot now # 立即重启
```

![[Linux/Arch/attachments/53bd5d0c41b026955264852b137beb07_MD5.png]]

## Windows/Linux双系统安装
### Windows和Linux在一个硬盘里
:::info
建议先安装Windows，再安装Linux，如果Windows后安装，Windows安装程序会把EFI分区完全覆盖掉，导致启动菜单没有Linux启动项，这个时候需要通过一个live Linux环境重建Linux系统引导，参造安装流程中的系统引导配置。// todo，待验证

:::

:::info
Windows系统需要关闭快速启动！

Windows系统需要关闭快速启动！

Windows系统需要关闭快速启动！

:::

```bash
powercfg /H off # 关闭快速启动
```

#### 扩容EFI System分区
一个硬盘中，只能有一个EFI分区，如果是先安装的windows，那么硬盘中就已经存在一个EFI分区了，在安装Linux时可以直接使用这个EFI分区，但是Windows默认给EFI分区分配的空间仅有200MB，在如果需要保存多个系统的引导，空间可能不太够，我们可以通过新建一个更大的EFI分区来替换掉之前的EFI分区。

![[Linux/Arch/attachments/7f557bb200050eef579460538366df1c_MD5.png]]

通过U盘进入到Linux live 环境

```bash
fdisk -l # 查看当前硬盘的分区情况
```

![[Linux/Arch/attachments/373efb7a09de7b6af58936b20ca7af23_MD5.png]]

```bash
mount --mkdir /dev/sda1 /efi # 挂载EFI分区
ls /efi # 查看EFI分区下的文件
cp -a /efi /efi_backup # 备份EFI分区中的文件
umount /efi # 卸载EFI分区
ls /efi_backup # 查看刚刚备份的文件
```

![[Linux/Arch/attachments/9e81fe0ff1ef47a83690b22a1b63033f_MD5.png]]

```bash
blkid | grep /dev/sda1 >> /esp_info.txt # 备份当前的分区信息
cat /esp_info.txt # 查看刚刚备份的信息
```

![[Linux/Arch/attachments/f5a2b7ee463ba22213aca4499238ea73_MD5.png]]

```bash
sgdisk -p /dev/sda
sgdisk --delete=1 /dev/sda
sgdisk --align-end --new=1:0:+4G --typecode=1:ef00 --change-name=1:'EFI system partition' --partition-guid=1:YYYYYYYY-YYYY-YYYY-YYYY-YYYYYYYYYYYY /dev/sda
partprobe /dev/sda
sgdisk -p /dev/sda
```

![[Linux/Arch/attachments/fbbea3b0a8f6d1add0f7bf44b04c2c57_MD5.png]]

```bash
mkfs.fat -F 32 -i XXXXXXX /dev/sda1
```

![[Linux/Arch/attachments/4dcbf42282cb23bfca69d67c78262b64_MD5.png]]

```bash
mount --mkdir /dev/sda1 /efi 挂载新的EFI分区到/efi挂载点
cp -a /efi_back/. /efi # 将刚刚备份的文件拷贝到新的efi分区中
ls /efi 
umount /efi # 卸载 /efi 挂载点
reboot now # 重启校验windows是否能够被正常启动
```

![[Linux/Arch/attachments/25c81ef92244e8a46a9685ecf47b6b69_MD5.png]]

#### 直接挂载已存在的EFI分区
跳过新增EFI分区步骤，直接挂载已存在的EFI分区

```bash
## mkfs.fat -F 32 /dev/sda1 # 不要执行
mount /dev/sda1 /mnt/efi/ --mkdir # 直接挂载efi分区
```

### Windows和Linux在两块硬盘里
Windows和Linux分别安装在不同的硬盘中，这种情况比较简单，因为没有EFI分区只能有一个的限制，只需要在最后创建系统引导时，加上windows的系统引导项即可。

:::info
每次系统更新或者内核更新后，如果需要更新grub配置文件，记得手动挂载包含windows启动项的分区，如果包含windows启动项的分区没有挂载的话会导致windows启动项找不到而丢失启动菜单。

:::

```bash
lsblk -pf # 查找包含windows启动项的分区
# 在生成grub配置文件前，先挂载包含windows启动项的分区
mount --mkdir /dev/sda1 /winboot
ls /winboot # 查看windows启动项是否成功挂载
grub-mkconfig -o /boot/grub/grub.cfg # 生成grub配置文件
```

![[Linux/Arch/attachments/bb0d9ebc413a00c7f63b08916a052827_MD5.png]]

## 删除系统
删除Linux只需要做三件事情

1. 删除启动项

```bash
efibootmgr # 查看当前已有的启动项
efibootmgr --delete-bootnum -b 3 # 删除Linux系统的启动项
```

![[Linux/Arch/attachments/c28a56829ca99c250024f96f45b66a42_MD5.png]]

2. 卸载grub

```bash
rm -rf /efi/EFI/grub/ /boot/grub/
```

3. 格式化硬盘分区

![[Linux/Arch/attachments/91f4a2778374bf55c186c76cd7806482_MD5.png]]

